name: Modify VS Code Extension (Manual)

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  modify-extension:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install required tools
        run: |
          npm install -g @vscode/vsce
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: Download Latest VSIX
        run: |
          PUBLISHER="augment"
          EXTENSION_NAME="vscode-augment"
          VSIX_URL="https://marketplace.visualstudio.com/_apis/public/gallery/publishers/${PUBLISHER}/vsextensions/${EXTENSION_NAME}/latest/vspackage"
          curl -L --compressed -o original.vsix "${VSIX_URL}"
          echo "VSIX downloaded successfully."

      - name: Unpack VSIX
        run: |
          unzip -q original.vsix -d unpacked_ext
          chmod -R u+w unpacked_ext
          echo "VSIX unpacked successfully."

      - name: Get extension version
        id: get_version
        run: |
          VERSION=$(jq -r .version unpacked_ext/extension/package.json)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Discovered extension version: ${VERSION}"

      - name: Check if version already exists
        id: check_version
        run: |
          TAG_NAME="augment-vscode-modified-v${VERSION}"
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG_NAME}$"; then
            echo "Tag ${TAG_NAME} already exists, skipping build"
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "Tag ${TAG_NAME} does not exist, proceeding with build"
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Find main entry file and variables
        if: steps.check_version.outputs.skip_build == 'false'
        run: |
          # æŸ¥æ‰¾ä¸»å…¥å£æ–‡ä»¶
          MAIN_FILE=""
          
          # å°è¯•ä»Ž package.json èŽ·å–ä¸»å…¥å£æ–‡ä»¶
          if [ -f "unpacked_ext/extension/package.json" ]; then
            MAIN_ENTRY=$(jq -r '.main // empty' unpacked_ext/extension/package.json)
            if [ -n "$MAIN_ENTRY" ] && [ -f "unpacked_ext/extension/$MAIN_ENTRY" ]; then
              MAIN_FILE="unpacked_ext/extension/$MAIN_ENTRY"
            fi
          fi
          
          # å¦‚æžœæ²¡æ‰¾åˆ°ï¼Œæœç´¢åŒ…å«ç‰¹å®šæ¨¡å¼çš„ JS æ–‡ä»¶
          if [ -z "$MAIN_FILE" ]; then
            for file in $(find unpacked_ext/extension -name "*.js" -type f); do
              if grep -q "handleAuthURI\|augment\.sessions" "$file" 2>/dev/null; then
                MAIN_FILE="$file"
                break
              fi
            done
          fi
          
          # å¦‚æžœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª JS æ–‡ä»¶
          if [ -z "$MAIN_FILE" ]; then
            MAIN_FILE=$(find unpacked_ext/extension -name "*.js" -type f | head -1)
          fi
          
          if [ -z "$MAIN_FILE" ]; then
            echo "Error: No suitable JavaScript file found"
            exit 1
          fi
          
          echo "Found main file: $MAIN_FILE"
          
          # å¤‡ä»½åŽŸæ–‡ä»¶
          cp "$MAIN_FILE" "${MAIN_FILE}.backup"
          
          # æŸ¥æ‰¾å˜é‡å
          SESSIONS_VAR=$(grep -o '[a-zA-Z_$][a-zA-Z0-9_$]*\s*=\s*"augment\.sessions"' "$MAIN_FILE" | sed 's/\s*=.*$//' | head -1)
          EMAIL_VAR=$(grep -o '[a-zA-Z_$][a-zA-Z0-9_$]*\s*=\s*\["email"\]' "$MAIN_FILE" | sed 's/\s*=.*$//' | head -1)
          
          if [ -z "$SESSIONS_VAR" ] || [ -z "$EMAIL_VAR" ]; then
            echo "Warning: Could not find required variable patterns, using fallback search"
            # å°è¯•æ›´å®½æ¾çš„æœç´¢
            SESSIONS_VAR=$(grep -o '[a-zA-Z_$][a-zA-Z0-9_$]*' "$MAIN_FILE" | grep -B5 -A5 "augment.sessions" | head -1)
            EMAIL_VAR=$(grep -o '[a-zA-Z_$][a-zA-Z0-9_$]*' "$MAIN_FILE" | grep -B5 -A5 "email" | head -1)
          fi
          
          # å¦‚æžœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨é»˜è®¤å€¼
          if [ -z "$SESSIONS_VAR" ]; then
            SESSIONS_VAR="x"
          fi
          if [ -z "$EMAIL_VAR" ]; then
            EMAIL_VAR="y"
          fi
          
          echo "Found sessions variable: $SESSIONS_VAR"
          echo "Found email variable: $EMAIL_VAR"
          
          # ä¿å­˜åˆ°çŽ¯å¢ƒå˜é‡
          echo "SESSIONS_VAR=$SESSIONS_VAR" >> $GITHUB_ENV
          echo "EMAIL_VAR=$EMAIL_VAR" >> $GITHUB_ENV
          echo "MAIN_FILE=$MAIN_FILE" >> $GITHUB_ENV

      - name: Apply modifications
        if: steps.check_version.outputs.skip_build == 'false'
        run: |
          echo "Applying modifications to $MAIN_FILE"

          # åˆ›å»ºä¿®æ”¹è„šæœ¬
          cat > modify_script.js << 'EOF'
          const fs = require('fs');
          const path = process.argv[2];
          const sessionsVar = process.argv[3];
          const emailVar = process.argv[4];

          let content = fs.readFileSync(path, 'utf8');

          // 0. æ’å…¥æ–‡ä»¶å¤´ä»£ç ï¼ˆå¦‚æžœ inject-code.txt å­˜åœ¨ï¼‰
          const injectCodePath = 'inject-code.txt';
          if (fs.existsSync(injectCodePath)) {
            const injectCode = fs.readFileSync(injectCodePath, 'utf8');
            content = injectCode + '\n' + content;
            console.log('âœ“ Injected header code from inject-code.txt');
          } else {
            console.log('â„¹ inject-code.txt not found, skipping header injection');
          }
          
          // 1. æ·»åŠ æ–°çš„ case åˆ° switch è¯­å¥
          // æŸ¥æ‰¾åŒ…å« handleAuthURI çš„ case è¯­å¥å¹¶åœ¨å…¶åŽæ·»åŠ æ–° case
          const handleAuthURIPattern = /(case[^:]*:[^}]*handleAuthURI[^}]*break;)/;
          const match = content.match(handleAuthURIPattern);
          
          if (match) {
            // ä»ŽçŽ°æœ‰çš„ handleAuthURI è°ƒç”¨ä¸­æå–å¯¹è±¡åå’Œå‚æ•°å
            const callPattern = /([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\.\s*handleAuthURI\s*\(\s*([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\)/;
            const callMatch = match[1].match(callPattern);
            
            let objectName = 'this';
            let paramName = 'e';
            
            if (callMatch) {
              objectName = callMatch[1];
              paramName = callMatch[2];
              console.log(`âœ“ Extracted variables: ${objectName}.handleAuthURI(${paramName})`);
            } else {
              console.log('âš  Could not extract variables from handleAuthURI call, using defaults');
            }
            
            const newCase = `case "/autoAuth":${objectName}.handleAutoAuth(${paramName});break;`;
            content = content.replace(handleAuthURIPattern, match[1] + newCase);
            console.log('âœ“ Added new case to switch statement');
          } else {
            console.log('âš  Could not find handleAuthURI case, trying alternative approach');
            // å°è¯•åœ¨ä»»ä½• break; åŽæ·»åŠ ï¼ŒåŒæ—¶æå–å˜é‡
            const altPattern = /([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\.\s*handleAuthURI\s*\(\s*([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\)[^}]*break;/;
            const altMatch = content.match(altPattern);
            
            if (altMatch) {
              const objectName = altMatch[1];
              const paramName = altMatch[2];
              const newCase = `case "/autoAuth":${objectName}.handleAutoAuth(${paramName});break;`;
              content = content.replace(altPattern, `$&${newCase}`);
              console.log(`âœ“ Added case using extracted variables: ${objectName}.handleAutoAuth(${paramName})`);
            } else {
              console.log('âš  Could not find handleAuthURI pattern, using fallback');
              content = content.replace(/handleAuthURI[^}]*break;/, '$&case "/autoAuth":this.handleAutoAuth(e);break;');
            }
          }
          
          // 2. æ·»åŠ æ–°çš„ handleAutoAuth æ–¹æ³•
          const newMethod = `async handleAutoAuth(e) {
              try {
                  const params = new URLSearchParams(e.query);
                  const accessToken = params.get('token');
                  const tenantURL = params.get('url');
                  await this._context.secrets.store(${sessionsVar},JSON.stringify({accessToken,tenantURL,scopes:${emailVar}})); 
                  this._sessionChangeEmitter.fire({accessToken,tenantURL,scopes:${emailVar}}); 
              } catch (e) {
                  this._logger.warn("Failed to process auth request:", e), this._programmaticCancellation.fire(mt(e))
              }
          }`;
          
          // æŸ¥æ‰¾ async handleAuthURI æ–¹æ³•çš„ç»“æŸä½ç½®
          const methodPattern = /(async\s+handleAuthURI[^{]*\{(?:[^{}]|\{[^{}]*\})*\})/;
          const methodMatch = content.match(methodPattern);
          
          if (methodMatch) {
            content = content.replace(methodPattern, methodMatch[1] + newMethod);
            console.log('âœ“ Added new handleAutoAuth method');
          } else {
            console.log('âš  Could not find handleAuthURI method, appending at end');
            content += '\n' + newMethod;
          }
          
          fs.writeFileSync(path, content);
          console.log('Modifications completed');
          EOF
          
          # è¿è¡Œä¿®æ”¹è„šæœ¬
          node modify_script.js "$MAIN_FILE" "$SESSIONS_VAR" "$EMAIL_VAR"

      - name: Verify modifications
        if: steps.check_version.outputs.skip_build == 'false'
        run: |
          echo "Verifying modifications..."
          
          # æ£€æŸ¥æ–°çš„ case æ˜¯å¦æ·»åŠ æˆåŠŸ
          if grep -q 'case "/autoAuth"' "$MAIN_FILE"; then
            echo "âœ“ New case added successfully"
          else
            echo "âœ— Failed to add new case"
            exit 1
          fi
          
          # æ£€æŸ¥æ–°æ–¹æ³•æ˜¯å¦æ·»åŠ æˆåŠŸ
          if grep -q "handleAutoAuth" "$MAIN_FILE"; then
            echo "âœ“ New method added successfully"
          else
            echo "âœ— Failed to add new method"
            exit 1
          fi
          
          echo "All modifications verified successfully"



      - name: Repack VSIX
        if: steps.check_version.outputs.skip_build == 'false'
        run: |
          cd unpacked_ext
          # é‡æ–°æ‰“åŒ…ä¸º VSIX
          zip -r "../augment-vscode-modified-v${{ env.VERSION }}.vsix" . -x "*.git*"
          cd ..
          echo "VSIX repacked successfully as augment-vscode-modified-v${{ env.VERSION }}.vsix"

      - name: Upload modified VSIX
        if: steps.check_version.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: augment-vscode-modified-v${{ env.VERSION }}
          path: augment-vscode-modified-v${{ env.VERSION }}.vsix
          retention-days: 30

      - name: Create release
        if: github.ref == 'refs/heads/main' && steps.check_version.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: augment-vscode-modified-v${{ env.VERSION }}
          name: Augment VSCode Modified v${{ env.VERSION }}
          body: |
            ä¿®æ”¹å†…å®¹ï¼š
            - æ·»åŠ è‡ªåŠ¨ç™»å½•å›žè°ƒ
            - æ·»åŠ é˜²å°æ³¨å…¥

            åŸºäºŽåŽŸç‰ˆæœ¬: ${{ env.VERSION }}
          files: |
            augment-vscode-modified-v${{ env.VERSION }}.vsix
          draft: false
          prerelease: false

      - name: Send file to Telegram channel
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
            -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -F document="@augment-vscode-modified-v${{ env.VERSION }}.vsix" \
            --form-string caption="ðŸ“¦ æ–°æž„å»ºäº§ç‰©\nrepo: ${{ github.repository }}\nsha:  ${{ github.sha }}"
